<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>梅林服务器聊天室</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 样式保持不变 */
    </style>
</head>
<body>
    <!-- HTML结构保持不变 -->
    
    <!-- 添加Socket.IO客户端库 -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <script>
        // DOM元素
        const chatMessages = document.getElementById('chat-messages');
        const userNameInput = document.getElementById('user-name');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const themeToggle = document.getElementById('theme-toggle');
        const connectionStatus = document.getElementById('connection-status');
        const statusDot = connectionStatus.querySelector('.status-dot');
        
        // WebSocket连接变量
        let socket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_INTERVAL = 3000;
        
        // 初始化WebSocket连接
        function initWebSocket() {
            // 清理无效字符的URL
            const wsUrl = 'wss://wc.bioc.fun:1084'.replace(/\s/g, '');
            
            // 使用Socket.IO客户端
            socket = io(wsUrl, {
                reconnection: true,
                reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
                reconnectionDelay: RECONNECT_INTERVAL,
                transports: ['websocket'],
                path: '/socket.io',
                query: {
                    clientType: 'web'
                }
            });
            
            // 连接事件
            socket.on('connect', () => {
                console.log('WebSocket连接已建立');
                updateConnectionStatus(true);
                reconnectAttempts = 0;
                
                // 发送用户加入通知
                if (userNameInput.value.trim()) {
                    socket.emit('user_join', userNameInput.value.trim());
                }
            });
            
            // 接收消息
            socket.on('message', (message) => {
                addMessageToChat(message, false);
            });
            
            // 断开连接事件
            socket.on('disconnect', (reason) => {
                console.log('WebSocket连接断开:', reason);
                updateConnectionStatus(false);
                
                if (reason === 'io server disconnect') {
                    // 服务器主动断开，需要手动重连
                    socket.connect();
                }
            });
            
            // 连接错误
            socket.on('connect_error', (error) => {
                console.error('WebSocket连接错误:', error);
                updateConnectionStatus(false);
            });
            
            // 重连事件
            socket.on('reconnect', (attempt) => {
                console.log(`WebSocket重新连接成功 (尝试 ${attempt} 次)`);
                updateConnectionStatus(true);
            });
            
            // 重连尝试
            socket.on('reconnect_attempt', (attempt) => {
                console.log(`WebSocket重新连接尝试 (${attempt}/${MAX_RECONNECT_ATTEMPTS})`);
                connectionStatus.querySelector('span').textContent = 
                    `重新连接中 (${attempt}/${MAX_RECONNECT_ATTEMPTS})...`;
            });
            
            // 重连失败
            socket.on('reconnect_failed', () => {
                console.error('WebSocket重新连接失败');
                connectionStatus.querySelector('span').textContent = 
                    '连接失败，请刷新页面重试';
            });
        }
        
        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.classList.add('connected');
                connectionStatus.querySelector('span').textContent = '已连接';
            } else {
                connectionStatus.classList.remove('connected');
                connectionStatus.querySelector('span').textContent = '连接断开，正在重连...';
            }
        }
        
        // 添加消息到聊天框
        function addMessageToChat(message, isUserMessage = false) {
            // 保持不变
        }
        
        // 发送消息
        function sendMessage() {
            const userName = userNameInput.value.trim();
            const message = messageInput.value.trim();
            
            if (userName && message) {
                if (socket && socket.connected) {
                    // 通过WebSocket发送消息
                    socket.emit('send_message', {
                        user_name: userName,
                        message: message
                    });
                    
                    // 在本地显示用户消息
                    addMessageToChat(message, true);
                    
                    // 清空输入框
                    messageInput.value = '';
                } else {
                    alert('尚未连接到服务器，请稍后再试');
                }
            }
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 保持不变
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            initWebSocket();
            
            // 初始化消息
            addMessageToChat("欢迎来到梅林服务器聊天室!", false);
            addMessageToChat("请在上方输入用户名后开始聊天", false);
        });
    </script>
</body>
</html>
